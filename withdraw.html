<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Withdraw</title>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    // Firebase config (sizning mavjud konfiguratsiyangiz)
    const firebaseConfig = {
      apiKey: "AIzaSyDm5joBc7dicQrPvrmtH_v-RMhkQrIPcxY",
      authDomain: "nexalum-1.firebaseapp.com",
      projectId: "nexalum-1",
      storageBucket: "nexalum-1.firebasestorage.app",
      messagingSenderId: "418037039727",
      appId: "1:418037039727:web:8f0d8ed7c00cdf613f039a"
    };
    
    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Qurilma ID
    function getDeviceId() {
      let id = localStorage.getItem("deviceId");
      if (!id) {
        id = "dev_" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("deviceId", id);
      }
      return id;
    }
    const deviceId = getDeviceId();
    const userRef = doc(db, "users", deviceId);
    
    // Balansni yuklash va UI yangilash
    async function loadBalance() {
      try {
        const snap = await getDoc(userRef);
        const bal = snap.exists() ? Number(snap.data().balance ?? 0) : 0;
        // Xato holatlarda NaN bo'lmasligi uchun Number va ?? 0 ishlatdik
        document.getElementById("balance").innerText = bal.toFixed(2) + " ‚ÇΩ";
      } catch (err) {
        console.error("Balans yuklash xatosi:", err);
        document.getElementById("balance").innerText = "0.00 ‚ÇΩ";
      }
    }
    
    // Withdraw so‚Äòrov yuborish
    async function withdraw() {
      try {
        const payeer = document.getElementById("payeer").value.trim();
        const amount = parseFloat(document.getElementById("amount").value);
        const btn = document.querySelector('button[onclick="withdraw()"]');
        
        if (!payeer) {
          return alert("‚ùå Payeer raqamingizni kiriting!");
        }
        if (isNaN(amount) || amount < 50) {
          return alert("‚ùå Minimal yechish: 50 ‚ÇΩ");
        }

        // Tugmani bloklab qo'yamiz (duplicate so'rovlarni oldini olish uchun)
        if (btn) btn.disabled = true;

        // Har safar Firestore'dan oxirgi balansni olamiz
        const snap = await getDoc(userRef);
        const currentBalance = snap.exists() ? Number(snap.data().balance ?? 0) : 0;

        // Tekshiruv: balansingiz yetadimi?
        if (currentBalance < amount) {
          if (btn) btn.disabled = false;
          return alert("‚ùå Balansingiz yetarli emas!");
        }

        // Balansdan yechish
        await updateDoc(userRef, { balance: currentBalance - amount });

        // So‚Äòrovni Firestore ga yuborish (admin ko'rishi uchun)
        await addDoc(collection(db, "withdrawRequests"), {
          deviceId: deviceId,
          payeer: payeer,
          amount: amount,
          status: "pending",
          createdAt: new Date()
        });

        alert("‚úÖ So‚Äòrov yuborildi!");
        // Balansni yangilab ko'rsatamiz
        await loadBalance();
        if (btn) btn.disabled = false;
      } catch (err) {
        console.error("Withdraw xatosi:", err);
        alert("Xatolik yuz berdi. Konsolni tekshiring.");
        const btn = document.querySelector('button[onclick="withdraw()"]');
        if (btn) btn.disabled = false;
      }
    }

    // Module skript ichidagi funksiyani inline onclick ishlashi uchun globalga ajratamiz
    // (Dizaynga tegmadim, faqat JS qismi)
    window.withdraw = withdraw;

    document.addEventListener("DOMContentLoaded", loadBalance);
  </script>

  <style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #000;
    color: #fff;
    overflow: hidden;
  }
  .container {
    position: relative;
    z-index: 2;
    max-width: 400px;
    margin: 0 auto;
    padding: 40px;
    text-align: center;
  }
  h1 { margin-bottom: 20px; color: #00f; }
  input {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 6px;
    border: none;
  }
  button {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    border: none;
    border-radius: 6px;
    background: #28a745;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover { background: #1e7e34; }
  #balance { font-size: 20px; font-weight: bold; color: #00f; }

  .bubble {
    position: absolute;
    border-radius: 50%;
    background: rgba(0,150,255,0.3);
    animation: rise 10s linear infinite;
  }
  @keyframes rise {
    0% { transform: translateY(100vh) scale(0.5); opacity: 0.5;}
    50% { opacity: 0.7; }
    100% { transform: translateY(-10vh) scale(1); opacity: 0; }
  }
  </style>
</head>
<body>

<div class="container">
  <h1>üí∏ Withdraw</h1>
  <p>Balans: <span id="balance">0 ‚ÇΩ</span></p>
  <input type="text" id="payeer" placeholder="Payeer raqam (P100...)">
  <input type="number" id="amount" placeholder="Summa (‚ÇΩ)">
  <button onclick="withdraw()">‚úÖ Tasdiqlash</button>
</div>

<!-- Pufakchalar -->
<script>
for(let i=0;i<30;i++){
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.style.width = bubble.style.height = Math.random()*30 + 10 + "px";
  bubble.style.left = Math.random()*100 + "vw";
  bubble.style.animationDuration = (5 + Math.random()*5) + "s";
  document.body.appendChild(bubble);
}
</script>

</body>
</html>
